<!doctype html><html lang="en">
<!-- Mirrored from thadeusb.com/weblog/2009/12/31/web2py_virtualfields_as_an_orm_an_sqlalchemy_approach/ by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 31 Jan 2019 17:05:39 GMT -->
<head><title>web2py virtualfields as an ORM (an sqlalchemy approach) - ThadeusB</title><meta charset="utf-8"><meta name=author content="Thadeus Burgess" /><meta name=description content="One of the finer new features in web2py is the ability to declare what is called a &#34;virtual field&#34;. A virtual field is a function that gets called/calculated when the web2py DAL performs a select on the database tables. The neat thing about virtual"/><meta name=keywords content="python, ai, robots, web2py, virtualfield, sqlalchemy, python, web_develoment, database_orm, orm, virtualfields, approach"/><meta name=robots content="index, follow" /><link rel="shortcut icon" href="https://thadeusb.com/static/favicon.ico" type="image/x-icon" /><link href="http://fonts.googleapis.com/css?family=Rubik|Aclonica|Averia+Libre" rel="stylesheet"><link href="../../../../../../use.fontawesome.com/aaf60b2b39.css" rel="stylesheet"> <link rel="stylesheet" type="text/css" href="https://thadeusb.com/static/gen/app.css?5d06cfbf"><link rel="stylesheet" type="text/css" media="print" href="https://thadeusb.com/static/gen/print.css?39bef004"><meta name="viewport" content="width=device-width" /><meta name="twitter:card" content="summary"> <meta name="twitter:site" content="@thadeusb"> <meta name="twitter:creator" content="@thadeusb"> <meta name="twitter:title" content="web2py virtualfields as an ORM (an sqlalchemy approach)"> <meta name="twitter:description" content="One of the finer new features in web2py is the ability to declare what is called a &#34;virtual field&#34;. A virtual field is a function that gets called/calculated when the web2py DAL performs a select on the database tables. The neat thing about virtual"> <meta name="twitter:image" content="../../../../../index.html"></head><body class="weblog web2py_virtualfields_as_an_orm_an_sqlalchemy_approach  "><div class="container"><header class="header"><h1>Hi, I'm <a href="../../../../../index.html">Thadeus<span>B</span></a>.</h1><small>I code stuff. I raise bees. I game.</small></header><main class="content"><article lang="en" class="weblog" itemscope itemtype="//schema.org/BlogPosting"><link itemprop="url" href="index.html"><header><div id="article-title"></div><h2><a itemprop="name" href="index.html">web2py virtualfields as an ORM (an sqlalchemy approach)</a></h2></header><section><p>One of the finer new features in web2py is the ability to declare what is called a "virtual field".</p><p>A virtual field is a function that gets called/calculated when the web2py DAL performs a select on the database tables.</p><p>The neat thing about virtual fields, is it allows us to give the DAL ORM functionalities like you would find in django and sqlalchemy.</p><div class="codehilite"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;sales&#39;</span><span class="p">,</span>
    <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">),</span>
    <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;item_total&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
    <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;tax_percentage&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
    <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;trans_date&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">),</span>
<span class="p">)</span>

<span class="k">class</span> <span class="nc">Sales</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">total</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sales</span><span class="o">.</span><span class="n">item_total</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sales</span><span class="o">.</span><span class="n">tax_percentage</span>
    <span class="k">def</span> <span class="nf">tax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">total</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sales</span><span class="o">.</span><span class="n">item_total</span>

<span class="n">db</span><span class="o">.</span><span class="n">sales</span><span class="o">.</span><span class="n">virtualfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Sales</span><span class="p">())</span>

<span class="mi">2009</span><span class="n">_sales</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span>
    <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">sales</span><span class="o">.</span><span class="n">trans_date</span> <span class="o">&lt;=</span> <span class="s2">&quot;2009-12-31&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">sales</span><span class="o">.</span><span class="n">trans_date</span> <span class="o">&gt;=</span> <span class="s2">&quot;2009-01-01&quot;</span><span class="p">)</span>
  <span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">orderby</span><span class="o">=~</span><span class="n">db</span><span class="o">.</span><span class="n">sales</span><span class="o">.</span><span class="n">trans_date</span><span class="p">)</span>


<span class="k">for</span> <span class="n">sale</span> <span class="ow">in</span> <span class="mi">2009</span><span class="n">_sales</span><span class="p">:</span>
    <span class="k">print</span> <span class="s2">&quot;Item: &quot;</span><span class="p">,</span> <span class="n">sale</span><span class="o">.</span><span class="n">item</span>
    <span class="k">print</span> <span class="s2">&quot;Price: &quot;</span><span class="p">,</span> <span class="n">sale</span><span class="o">.</span><span class="n">item_total</span>
    <span class="k">print</span> <span class="s2">&quot;Tax: &quot;</span><span class="p">,</span> <span class="n">sale</span><span class="o">.</span><span class="n">tax</span> <span class="c1"># Notice, we are getting from our virtualfield class we defined!</span>
    <span class="k">print</span> <span class="s2">&quot;Total: &quot;</span><span class="p">,</span> <span class="n">sale</span><span class="o">.</span><span class="n">total</span>
</pre></div><p>Sometimes you might want a lazy virtualfield that only gets calculated when you call it. A blog post permalink would be a situation where this would be beneficial.</p><div class="codehilite"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">,</span>
    <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">),</span>
    <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="k">class</span> <span class="nc">Post</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">permalink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">lzy</span><span class="p">():</span>
            <span class="c1"># Define an inner function that will perform our action</span>
            <span class="k">return</span> <span class="n">URL</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">))</span>
        <span class="c1"># We are only returning a reference to the function, this will get called later!</span>
        <span class="k">return</span> <span class="n">lzy</span>

<span class="n">db</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">virtualfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Post</span><span class="p">())</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
    <span class="k">print</span> <span class="n">row</span><span class="o">.</span><span class="n">title</span>
    <span class="k">print</span> <span class="n">row</span><span class="o">.</span><span class="n">permalink</span><span class="p">()</span> <span class="c1"># Notice, we have to call the fucntion!</span>
    <span class="k">print</span> <span class="n">content</span>
</pre></div></section><hr><aside><p><span class="article-author" itemprop="author" itemscope itemtype="//schema.org/Person"><span itemprop="name">Thadeus Burgess</span></span><time datetime="2009-12-31" itemprop="datePublished">2009-12-31</time>— in <a href="../../../../index.html" itemprop="genre">Weblog</a></p></aside><nav><a class="prev" href="../../../../2010/01/03/web2py_dynamic_queries/index.html">web2py dynamic queries</a> |<a class="next" href="../../../04/15/pygame_font_and_py2exe/index.html">pygame font and py2exe</a><div class="related"><h6>Related Entries <small>(in order of similarity)</small></h6><ul><li><a href="../../../../2010/09/03/sqlalchemy_record_instance_item_access/index.html">Getting fresh with SQLAlchemy</a></li><li><a href="../../../../2010/01/17/download_of_a_filelike_python_object_in_web2py/index.html">Download of a file-like python object in web2py</a></li><li><a href="../../../../2012/10/18/safe_calculator/index.html">Safe Calculator In Python</a></li><li><a href="../../../../2011/08/17/manage_python_virtualenv/index.html">Seemless Python VirtualEnv Integration</a></li><li><a href="../../../../2010/10/10/python_scale_hex_color/index.html">Scale a hex color in Python</a></li><li><a href="../../../../2010/08/23/python_multiple_decorators/index.html">Multiple Decorators for python functions</a></li></ul></div></nav></article></main><nav class="sidebar"><ul><li class="home"><a href="../../../../../index.html">Home</a></li><li class="weblog active"><a href="../../../../index.html">Weblog</a></li><li class="recipes"><a href="../../../../../recipes/index.html">Recipes</a></li><li class="projects"><a href="../../../../../projects/index.html">Projects</a></li><li class="contact"><a href="../../../../../pages/contact/index.html">Contact</a></li></ul></nav><footer class="footer"><p>&copy; 2017 Thadeus Burgess— <a href="mailto:thadeusb@thadeusb.com" title="E-Mail"><i class="fa fa-fw fa-envelope"></i></a>— <a href="https://github.com/thadeusb" title="GitHub"><i class="fa fa-fw fa-github"></i></a>— <a href="https://www.linkedin.com/in/thadeusb/" title="LinkedIn"><i class="fa fa-fw fa-linkedin"></i></a></p></footer></div><div id="gear-container"><div id="gear"></div></div><script src="../../../../../../ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script> <script type="text/javascript" src="https://thadeusb.com/static/gen/app.js?35034e78"></script><!--  GOOGLE ANALYTICS --> <script>var _gaq = _gaq || [];_gaq.push(['_setAccount', 'UA-7293044-1']);_gaq.push(['_trackPageview']);(function() {  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);})();</script></body>
<!-- Mirrored from thadeusb.com/weblog/2009/12/31/web2py_virtualfields_as_an_orm_an_sqlalchemy_approach/ by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 31 Jan 2019 17:05:39 GMT -->
</html>