<!doctype html><html lang="en">
<!-- Mirrored from thadeusb.com/weblog/2010/01/03/web2py_dynamic_queries/ by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 31 Jan 2019 17:05:50 GMT -->
<head><title>web2py dynamic queries - ThadeusB</title><meta charset="utf-8"><meta name=author content="Thadeus Burgess" /><meta name=description content="In many cases you might need a query based on multiple sets of information. Think of a search box, where you would like to provide the option to search in multiple areas (title, content, authors) or exclude these areas. Or a customer management system, i"/><meta name=keywords content="python, ai, robots, web2py, dal, query, dynamic_query, dynamic, queries"/><meta name=robots content="index, follow" /><link rel="shortcut icon" href="https://thadeusb.com/static/favicon.ico" type="image/x-icon" /><link href="http://fonts.googleapis.com/css?family=Rubik|Aclonica|Averia+Libre" rel="stylesheet"><link href="../../../../../../use.fontawesome.com/aaf60b2b39.css" rel="stylesheet"> <link rel="stylesheet" type="text/css" href="https://thadeusb.com/static/gen/app.css?5d06cfbf"><link rel="stylesheet" type="text/css" media="print" href="https://thadeusb.com/static/gen/print.css?39bef004"><meta name="viewport" content="width=device-width" /><meta name="twitter:card" content="summary"> <meta name="twitter:site" content="@thadeusb"> <meta name="twitter:creator" content="@thadeusb"> <meta name="twitter:title" content="web2py dynamic queries"> <meta name="twitter:description" content="In many cases you might need a query based on multiple sets of information. Think of a search box, where you would like to provide the option to search in multiple areas (title, content, authors) or exclude these areas. Or a customer management system, i"> <meta name="twitter:image" content="../../../../../index.html"></head><body class="weblog web2py_dynamic_queries  "><div class="container"><header class="header"><h1>Hi, I'm <a href="../../../../../index.html">Thadeus<span>B</span></a>.</h1><small>I code stuff. I raise bees. I game.</small></header><main class="content"><article lang="en" class="weblog" itemscope itemtype="//schema.org/BlogPosting"><link itemprop="url" href="index.html"><header><div id="article-title"></div><h2><a itemprop="name" href="index.html">web2py dynamic queries</a></h2></header><section><p>In many cases you might need a query based on multiple sets of information. Think of a search box, where you would like to provide the option to search in multiple areas (title, content, authors) or exclude these areas. Or a customer management system, in which a query can be provided by the customer name, phone number, or any other number of options that can be filtered down. There are of course, any number of situations that you may need IF logic in your database queries. </p><p>Appending results of several database SELECT statements would not be advisable, since it accesses the database several times, and leads to slow, inefficient design. The goal is to only hit the database once, while getting all of the needed information.This is where a <strong>dynamic query</strong> would come in handy. In web2py, this can be accomplished in multiple ways.</p><p>The simplest way of creating a dynamic web2py query is to start off with a blank Set object, and then filter the query down from there.</p><div class="codehilite"><pre><span></span><span class="n">qset</span><span class="o">=</span><span class="n">db</span><span class="p">()</span>
<span class="k">if</span> <span class="n">arg1</span> <span class="o">==</span> <span class="s2">&quot;xyz&quot;</span><span class="p">:</span> <span class="n">qset</span><span class="o">=</span><span class="n">qset</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">if</span> <span class="n">arg2</span> <span class="o">==</span> <span class="s2">&quot;xyz&quot;</span><span class="p">:</span> <span class="n">qset</span><span class="o">=</span><span class="n">qset</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">def</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">qset</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
</pre></div><p>For a more advanced version, you can append a query to a list and use python's <code>reduce</code> function.</p><div class="codehilite"><pre><span></span><span class="n">queries</span><span class="o">=</span><span class="p">[]</span>
<span class="k">if</span> <span class="n">arg1</span> <span class="o">==</span> <span class="s2">&quot;xyz&quot;</span><span class="p">:</span> <span class="n">queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">if</span> <span class="n">arg2</span> <span class="o">==</span> <span class="s2">&quot;xyz&quot;</span><span class="p">:</span> <span class="n">queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">def</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="nb">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">:(</span><span class="n">a</span><span class="o">&amp;</span><span class="n">b</span><span class="p">),</span><span class="n">queries</span><span class="p">)</span>
<span class="n">query</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
</pre></div><p>Or if you are doing the same kind of query, to a list of results</p><div class="codehilite"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">q</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">(</span> <span class="c1"># Start off with a default query</span>
              <span class="n">db</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> 
            <span class="o">|</span> <span class="n">db</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Then run through each element, and search for that specific word in the test.</span>
<span class="k">for</span> <span class="n">qs</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)):</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">query</span> <span class="o">|</span> <span class="n">db</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

<span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
</pre></div></section><hr><aside><p><span class="article-author" itemprop="author" itemscope itemtype="//schema.org/Person"><span itemprop="name">Thadeus Burgess</span></span><time datetime="2010-01-03" itemprop="datePublished">2010-01-03</time>— in <a href="../../../../index.html" itemprop="genre">Weblog</a></p></aside><nav><a class="prev" href="../../04/table_inheritance_with_web2py_dal/index.html">Table Inheritance with web2py DAL</a> |<a class="next" href="../../../../2009/12/31/web2py_virtualfields_as_an_orm_an_sqlalchemy_approach/index.html">web2py virtualfields as an ORM (an sqlalchemy approach)</a><div class="related"><h6>Related Entries <small>(in order of similarity)</small></h6><ul><li><a href="../../../03/19/increase_productivity_by_using_parameterized_queries_with_web2py/index.html">Increase Productivity By Using Parameterized Queries with web2py</a></li><li><a href="../../05/query_between_dates/index.html">Query between dates</a></li><li><a href="../../../04/21/using_fixtures_in_web2py/index.html">Using fixtures in web2py</a></li><li><a href="../../../02/01/check_reserved_sql_keywords_on_web2py_dal/index.html">Check reserved SQL Keywords on web2py DAL</a></li><li><a href="../../04/table_inheritance_with_web2py_dal/index.html">Table Inheritance with web2py DAL</a></li><li><a href="../../../09/03/sqlalchemy_record_instance_item_access/index.html">Getting fresh with SQLAlchemy</a></li></ul></div></nav></article></main><nav class="sidebar"><ul><li class="home"><a href="../../../../../index.html">Home</a></li><li class="weblog active"><a href="../../../../index.html">Weblog</a></li><li class="recipes"><a href="../../../../../recipes/index.html">Recipes</a></li><li class="projects"><a href="../../../../../projects/index.html">Projects</a></li><li class="contact"><a href="../../../../../pages/contact/index.html">Contact</a></li></ul></nav><footer class="footer"><p>&copy; 2017 Thadeus Burgess— <a href="mailto:thadeusb@thadeusb.com" title="E-Mail"><i class="fa fa-fw fa-envelope"></i></a>— <a href="https://github.com/thadeusb" title="GitHub"><i class="fa fa-fw fa-github"></i></a>— <a href="https://www.linkedin.com/in/thadeusb/" title="LinkedIn"><i class="fa fa-fw fa-linkedin"></i></a></p></footer></div><div id="gear-container"><div id="gear"></div></div><script src="../../../../../../ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script> <script type="text/javascript" src="https://thadeusb.com/static/gen/app.js?35034e78"></script><!--  GOOGLE ANALYTICS --> <script>var _gaq = _gaq || [];_gaq.push(['_setAccount', 'UA-7293044-1']);_gaq.push(['_trackPageview']);(function() {  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);})();</script></body>
<!-- Mirrored from thadeusb.com/weblog/2010/01/03/web2py_dynamic_queries/ by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 31 Jan 2019 17:05:50 GMT -->
</html>