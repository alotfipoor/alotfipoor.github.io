<!doctype html><html lang="en">
<!-- Mirrored from thadeusb.com/weblog/2010/04/21/using_fixtures_in_web2py/ by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 31 Jan 2019 17:05:58 GMT -->
<head><title>Using fixtures in web2py - ThadeusB</title><meta charset="utf-8"><meta name=author content="Thadeus Burgess" /><meta name=description content="So you are ready to deploy your newly finished web2py app, but you don&#39;t like the idea of having to manually insert all of this fixture data again! Create a new model, and name it ``x_fixtures.py``. This way it will execute after all of your models."/><meta name=keywords content="python, ai, robots, prepopulate, data, fixtures, yaml, truncate, reset, dal, web2py, using"/><meta name=robots content="index, follow" /><link rel="shortcut icon" href="https://thadeusb.com/static/favicon.ico" type="image/x-icon" /><link href="http://fonts.googleapis.com/css?family=Rubik|Aclonica|Averia+Libre" rel="stylesheet"><link href="../../../../../../use.fontawesome.com/aaf60b2b39.css" rel="stylesheet"> <link rel="stylesheet" type="text/css" href="https://thadeusb.com/static/gen/app.css?5d06cfbf"><link rel="stylesheet" type="text/css" media="print" href="https://thadeusb.com/static/gen/print.css?39bef004"><meta name="viewport" content="width=device-width" /><meta name="twitter:card" content="summary"> <meta name="twitter:site" content="@thadeusb"> <meta name="twitter:creator" content="@thadeusb"> <meta name="twitter:title" content="Using fixtures in web2py"> <meta name="twitter:description" content="So you are ready to deploy your newly finished web2py app, but you don&#39;t like the idea of having to manually insert all of this fixture data again! Create a new model, and name it ``x_fixtures.py``. This way it will execute after all of your models."> <meta name="twitter:image" content="../../../../../index.html"></head><body class="weblog using_fixtures_in_web2py  "><div class="container"><header class="header"><h1>Hi, I'm <a href="../../../../../index.html">Thadeus<span>B</span></a>.</h1><small>I code stuff. I raise bees. I game.</small></header><main class="content"><article lang="en" class="weblog" itemscope itemtype="//schema.org/BlogPosting"><link itemprop="url" href="index.html"><header><div id="article-title"></div><h2><a itemprop="name" href="index.html">Using fixtures in web2py</a></h2></header><section><p>So you are ready to deploy your newly finished web2py app, but you don't like the idea of having to manually insert all of this fixture data again!</p><p>Create a new model, and name it <code>x_fixtures.py</code>. This way it will execute after all of your models.</p><p>Then for every table that you want to pre-populate use the following snippet. I will use an example for the <code>auth_user</code> table to pre-create a test user.</p><div class="codehilite"><pre><span></span><span class="k">if</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">auth_user</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">auth_user</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
        <span class="n">first_name</span><span class="o">=</span><span class="s1">&#39;Testers&#39;</span><span class="p">,</span>
        <span class="n">last_name</span><span class="o">=</span><span class="s1">&#39;Inc&#39;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="s1">&#39;test@user.com&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="s1">&#39;&lt;include a pre-encrypted password here&gt;&#39;</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div><p>Basically, if we have no records in the table, insert the defaults! This is probably more useful in situations where you have pre-defined data that can be dynamic, such as a list of status codes.</p><div class="codehilite"><pre><span></span><span class="k">if</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
   <span class="n">db</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;pending&#39;</span><span class="p">,</span> <span class="n">kkey</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">)</span>
   <span class="n">db</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;processing&#39;</span><span class="p">,</span> <span class="n">kkey</span><span class="o">=</span><span class="s1">&#39;R&#39;</span><span class="p">)</span>
   <span class="n">db</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;done&#39;</span><span class="p">,</span> <span class="n">kkey</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
</pre></div><p>You can easily keep your data fixtures in a <a href="http://www.yaml.org/">YAML</a> file and load them into the database by using the <a href="http://pyyaml.org/wiki/PyYAMLDocumentation">pyyaml</a> library.</p><p>Here is the example YAML file for what we just inserted.</p><div class="codehilite"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">auth_user</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">first_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Testers</span>
      <span class="l l-Scalar l-Scalar-Plain">last_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Inc</span>
      <span class="l l-Scalar l-Scalar-Plain">email</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">test@user.com</span>
      <span class="l l-Scalar l-Scalar-Plain">password</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;include a pre-encrypted password here&gt;</span>
<span class="l l-Scalar l-Scalar-Plain">status</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">In-Queue</span>
      <span class="l l-Scalar l-Scalar-Plain">kkey</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Q</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Pending</span>
      <span class="l l-Scalar l-Scalar-Plain">kkey</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">P</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Processing</span>
      <span class="l l-Scalar l-Scalar-Plain">kkey</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">R</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Done</span>
      <span class="l l-Scalar l-Scalar-Plain">kkey</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">D</span>
</pre></div><p>We just open the file, pass this to pyyaml, and insert into the database, easy right?</p><div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">yaml</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/path/to/applications/myapp/private/fixtures.yaml&#39;</span><span class="p">))</span>

<span class="k">for</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">rows</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="n">db</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
            <span class="o">**</span><span class="n">r</span>
        <span class="p">)</span>
</pre></div><blockquote>
<p>Video on Generate web2py model by using yaml -&gt; http://vimeo.com/10837176</p>
</blockquote><p>Now you have gone done it, you placed your code on the production server, and found a bug! Now we need to reset the database to square one.</p><p><em>Note: Your table indexes will not reset to 0</em></p><p>Add the following code to the top of your x_fixtures.py file, when you want to reset the database, just change <code>RESET</code> to <code>True</code>.</p><div class="codehilite"><pre><span></span><span class="n">RESET</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">if</span> <span class="n">RESET</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">tables</span><span class="p">:</span>
        <span class="c1"># Make sure to cascade, or this will fail </span>
        <span class="c1"># for tables that have FK references.</span>
        <span class="n">db</span><span class="p">[</span><span class="n">table</span><span class="p">]</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="s2">&quot;CASCADE&quot;</span><span class="p">)</span>    
    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div><p>Make sure to remove your x_fixtures.py file when you are ready to go live! And <a href="../compile_web2py_apps_externally/index.html">compile that app!</a></p></section><hr><aside><p><span class="article-author" itemprop="author" itemscope itemtype="//schema.org/Person"><span itemprop="name">Thadeus Burgess</span></span><time datetime="2010-04-21" itemprop="datePublished">2010-04-21</time>— in <a href="../../../../index.html" itemprop="genre">Weblog</a></p></aside><nav><a class="prev" href="../../28/web2py_utilities/index.html">Web2py Utilities</a> |<a class="next" href="../compile_web2py_apps_externally/index.html">Compile web2py apps externally</a><div class="related"><h6>Related Entries <small>(in order of similarity)</small></h6><ul><li><a href="../../../03/19/increase_productivity_by_using_parameterized_queries_with_web2py/index.html">Increase Productivity By Using Parameterized Queries with web2py</a></li><li><a href="../../../02/01/check_reserved_sql_keywords_on_web2py_dal/index.html">Check reserved SQL Keywords on web2py DAL</a></li><li><a href="../../../01/05/query_between_dates/index.html">Query between dates</a></li><li><a href="../../../01/04/table_inheritance_with_web2py_dal/index.html">Table Inheritance with web2py DAL</a></li><li><a href="../../../01/03/web2py_dynamic_queries/index.html">web2py dynamic queries</a></li><li><a href="../../../08/27/how_to_fix_a_clicking_dead_harddrive_by_freezing/index.html">The quest to fix the dead clicking hard drive with FREEZE</a></li></ul></div></nav></article></main><nav class="sidebar"><ul><li class="home"><a href="../../../../../index.html">Home</a></li><li class="weblog active"><a href="../../../../index.html">Weblog</a></li><li class="recipes"><a href="../../../../../recipes/index.html">Recipes</a></li><li class="projects"><a href="../../../../../projects/index.html">Projects</a></li><li class="contact"><a href="../../../../../pages/contact/index.html">Contact</a></li></ul></nav><footer class="footer"><p>&copy; 2017 Thadeus Burgess— <a href="mailto:thadeusb@thadeusb.com" title="E-Mail"><i class="fa fa-fw fa-envelope"></i></a>— <a href="https://github.com/thadeusb" title="GitHub"><i class="fa fa-fw fa-github"></i></a>— <a href="https://www.linkedin.com/in/thadeusb/" title="LinkedIn"><i class="fa fa-fw fa-linkedin"></i></a></p></footer></div><div id="gear-container"><div id="gear"></div></div><script src="../../../../../../ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script> <script type="text/javascript" src="https://thadeusb.com/static/gen/app.js?35034e78"></script><!--  GOOGLE ANALYTICS --> <script>var _gaq = _gaq || [];_gaq.push(['_setAccount', 'UA-7293044-1']);_gaq.push(['_trackPageview']);(function() {  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);})();</script></body>
<!-- Mirrored from thadeusb.com/weblog/2010/04/21/using_fixtures_in_web2py/ by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 31 Jan 2019 17:05:58 GMT -->
</html>